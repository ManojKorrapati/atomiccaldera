# Atomic-Caldera
A Python 3 script to convert Red Canary Atomic Red Team Tests to MITRE Caldera Stockpile YAML ability files.

## Backstory
While looking into tools to help test and develop Red/Blue (Purple) teams by running MITRE ATT&CK mapped tests, I investigated MITRE's Caldera (https://github.com/mitre/caldera) and liked what I saw. I did not like that Caldera does not included many abilities/tests by default. I also looked at Red Canay's Atomic Red Team (https://github.com/redcanaryco/atomic-red-team), there are lot of tests included with Atomic Red Team but the included testing framework wasn't as nice as Caldera. I also like the Sandcat (https://github.com/mitre/sandcat) plugin included with Caldera. It can easily be run on many different endpoints, it is light weight, and provides the capability to perform tests from a central Caldera server. By combining the tests from Red Canary's Atomic Red Team with the testing framework of MITRE's Caldera the best of both tool sets could be enjoyed.

I looked around and did not find any tools to convert Red Canary's Atomic Red Team tests to MITRE Caldera Stockpile (https://github.com/mitre/stockpile) format. My desire to quickly build a library using the high quality tests provided by Red Canary in MITRE's Caldera framework drove me to write a "quick" script.

## Requirements
Python 3.6.8+ with the following libraries installed
* PyYAML - https://pyyaml.org/wiki/PyYAML
* STIX2 - https://github.com/oasis-open/cti-python-stix2

Atomic-Caldera requires the following repositories be stored locally somewhere:
* https://github.com/redcanaryco/atomic-red-team
* https://github.com/mitre/cti

## Installation
Install required Python modules:
```
pip install -r requirements.txt
```
Clone the Red Canary Atomic Red Team repository:
```
git clone https://github.com/redcanaryco/atomic-red-team.git
```
Clone the MITRE CTI repository:
```
git clone https://github.com/mitre/cti.git
```

## Usage
### Atomic-Caldera.py
Atomic-Caldera requires only two parameters to run. The input directory where the Red Canary Atomic Red Team "atomics" folder is located and the path to the MITRE CTI repository. The output folder option and CSV file options are optional, if they are not supplied, Atomic-Caldera will save these files in the current working directory.
```
usage: Atomic-Caldera.py [-h] [-i INPUTDIR] [-f FILEOUTDIR] [-c CTI] [-o CSV]
                         [-v VARCSV]

Convert Red Canary Attomic Red Team YAML files to Caldera Stockpile YAML
files.

optional arguments:
  -h, --help            show this help message and exit
  -i INPUTDIR, --inputdir INPUTDIR
                        The Red Canary "atomics" folder path.
  -f FILEOUTDIR, --fileoutdir FILEOUTDIR
                        The directory that the converted YAML files will be
                        stored in.
  -c CTI, --cti CTI     The path to the MITRE CTI database, ./cti is used by
                        default.
  -o CSV, --csv CSV     The path to the CSV catalog file.
  -v VARCSV, --varcsv VARCSV
                        The path to the CSV file containing variables for each
                        test.
```

*Example*
```
./Atomic-Caldera.py -i ~/repos/atomic-red-team/atomics -c ~/repos/cti
```
*Example*
```
./Atomic-Caldera.py -i ~/repos/atomic-red-team/atomics -c ~/repos/cti -f ~/woring/ -o ~/working/atomic-caldera.csv -v ~/working/atomic-variables.csv
```
### Update-AtomicVariables.py
Update-AtomicVariables requires only two parameters to run. The input directory containing the abilities YAML files that were generated by the Atomic-Caldera.py script and the path to the CSV file containing the variable values that will be used to populate the abilities YAML files. If the output option is not populated a new "abilities-updated" folder will be created in the same directory where the input source abilites are located.
```
usage: Update-AtomicVariables.py [-h] [-i INPUTDIR] [-o OUTPUTDIR] [-c CSV]

Populate the variable values in the abilities folder with those provided in
the supplied input CSV file.

optional arguments:
  -h, --help            show this help message and exit
  -i INPUTDIR, --inputdir INPUTDIR
                        The path to the "abilities" folder that needs to be
                        updated.
  -o OUTPUTDIR, --outputdir OUTPUTDIR
                        The path to store the updated "abilities" folder. If
                        no argument is provided, an "abilities-populated"
                        folder will be created.
  -c CSV, --csv CSV     The CSV file that will be used to update variable
                        values.
```

*Example*
```
./Update-AtomicVariables.py -i ~/working/abilities -c ~/working/atomic-variables.csv
````
*Example*
```
./Update-AtomicVariables.py -i ~/working/abilities -o ~/working/abilities-updated -c ~/working/atomic-variables.csv
```
## To-Do
The script is not perfect but, it gets the bulk fo the work done at this time. I would like to work on/fix the following eventually:
- [ ] Include the option to copy the generated '.yml' files into the correspoinding Caldera folders.
## ChangeLog
### v2.0
* Changed the default output to generate Caldera YML files with the variables intact. i.e. #{variable}
* Added a second CSV file output to output the CSV values so they can be edited before being imported to customize the tests.
* Added the Update-AtomicVariables.py script to populate the variable values and save the completed tests to a new directory.
* Added a wrapper script to support running Command Prompt commands using Caldera. Caldara supports Bash and PowerShell commands only. Some of the Atomic Red Team tests that were meant to run under the Command Prompt did not work properly due to formatting issues. The wrapper script spawns a new Command Prompt window and sends the keystrokes to run the commands. Once complete it copies the Command Prompt stdout to the clipboard so that the results can be displayed in Caldera's results window.
## License
See the [LICENSE](https://github.com/xenoscr/Atomic-Caldera/blob/master/LICENSE)

## Credits
* CTI and Caldara are maintained by MITRE: @mitre - https://github.com/mitre
* Atomic Red Team is maintained by Red Canary Co.: @redcanaryco - https://github.com/redcanaryco
